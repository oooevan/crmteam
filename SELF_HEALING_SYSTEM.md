# üîÑ –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∞—è—Å—è —Å–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è: "–î–∞–Ω–Ω—ã–µ –≤–∞–∂–Ω–µ–µ —Ñ–ª–∞–≥–æ–≤"

–í–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å —Ñ–ª–∞–≥–∞–º–∏ (`lastChangeSource`) –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
**"–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ª–∏–¥—ã) - —Å–æ—Ö—Ä–∞–Ω—è–π –∏—Ö –≤ Supabase"**

## üìã –¢—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞:

### 1Ô∏è‚É£ –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–µ–µ—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
```typescript
useEffect(() => {
  if (!hasLoadedFromServer || isLoading || isSyncing) return;

  // –°—á–∏—Ç–∞–µ–º –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ
  let leadsCount = 0;
  Object.values(data).forEach(u => {
    u.projects?.forEach(p => {
      leadsCount += Object.keys(p.leads || {}).length;
    });
  });

  // –ï—Å–ª–∏ –ª–∏–¥–æ–≤ 0 - —ç—Ç–æ –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
  // –ï—Å–ª–∏ –ª–∏–¥—ã –ü–û–Ø–í–ò–õ–ò–°–¨ - –æ–±—è–∑–∞–Ω—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
  if (leadsCount === 0) return;

  setTimeout(async () => {
    console.log(`üöÄ –û–ë–ù–ê–†–£–ñ–ï–ù–û –õ–ò–î–û–í: ${leadsCount}. –û–¢–ü–†–ê–í–õ–Ø–Æ...`);
    await saveData(data);
  }, 1500);
}, [data]);
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ "–ø–æ–Ω–∏–º–∞–µ—Ç", –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å

---

### 2Ô∏è‚É£ –£–º–Ω—ã–π –º–µ—Ä–∂–∏–Ω–≥ (Self-Healing Merge)
```typescript
setData(prev => {
  const next = JSON.parse(JSON.stringify(prev));

  Object.entries(newData).forEach(([user, serverUser]) => {
    next[user].projects = next[user].projects.map(localProj => {
      const serverProj = serverUser.projects.find(p => p.id === localProj.id);
      
      // –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –í–°–ï–ì–î–ê –≤–∞–∂–Ω–µ–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö
      const mergedLeads = { ...serverProj.leads, ...localProj.leads };
      
      return { 
        ...serverProj, 
        leads: mergedLeads,
        weeks: { ...serverProj.weeks, ...localProj.weeks }
      };
    });
  });

  return next;
});
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
- ‚úÖ –ï—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—à–ª–∞ –ø—É—Å—Ç–æ—Ç–∞ `{}`, –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—ë –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç
- ‚úÖ –ï—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—à–ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º
- ‚úÖ Non-Destructive Merge: –æ–±—ä–µ–¥–∏–Ω—è–µ–º, –∞ –Ω–µ –∑–∞–º–µ–Ω—è–µ–º

---

### 3Ô∏è‚É£ –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–π—Ç–∞
```typescript
const handleUpdate = (updater: (prev: AppData) => AppData) => {
  setData(prev => {
    const next = updater(prev);
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –¥–µ–±–∞–≥–∞
    const firstUser = Object.keys(next)[0];
    const leadsCount = Object.keys(next[firstUser]?.projects?.[0]?.leads || {}).length;
    console.log(`üìù –°—Ç–µ–π—Ç –æ–±–Ω–æ–≤–ª–µ–Ω. –õ–∏–¥–æ–≤: ${leadsCount}`);
    
    return next;
  });
};
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç - —Ä–∞–±–æ—Ç–∞–µ–º —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º state
- ‚úÖ –ù–µ—Ç –ª–∏—à–Ω–µ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ —Ü–µ–ª–∏–∫–æ–º:

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
```
–í–≤–æ–¥ "5" –≤ –ø–æ–ª–µ
     ‚Üì
onChange ‚Üí handleLeadChange ‚Üí handleUpdate
     ‚Üì
setData(prev => updater(prev))
     ‚Üì
üìù –°—Ç–µ–π—Ç –æ–±–Ω–æ–≤–ª–µ–Ω. –õ–∏–¥–æ–≤: 1
     ‚Üì
useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: leadsCount = 1 > 0
     ‚Üì
üöÄ –û–ë–ù–ê–†–£–ñ–ï–ù–û –õ–ò–î–û–í: 1. –û–¢–ü–†–ê–í–õ–Ø–Æ...
     ‚Üì
setIsSyncing(true)
     ‚Üì
üì§ saveData(data)
     ‚Üì
‚úÖ –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–û
     ‚Üì
setIsSyncing(false)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–∏–ª –¥–∞–Ω–Ω—ã–µ
```
üì° Realtime —Å–æ–±—ã—Ç–∏–µ –æ—Ç Supabase
     ‚Üì
subscribeToDataChanges callback
     ‚Üì
isSyncing? –ù–µ—Ç ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
     ‚Üì
setData(prev => {
  // –£–º–Ω—ã–π –º–µ—Ä–∂–∏–Ω–≥
  mergedLeads = { ...serverProj.leads, ...localProj.leads }
})
     ‚Üì
–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –ª–æ–∫–∞–ª—å–Ω—ã–µ –ª–∏–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
     ‚Üì
useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
     ‚Üì
–ù–û: –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (leadsCount –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
–∏–ª–∏ isSyncing=true, —Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞" - —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—à–ª–∏ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
```
üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: { leads: {} }
     ‚Üì
–£–º–Ω—ã–π –º–µ—Ä–∂–∏–Ω–≥:
mergedLeads = { ...{}, ...{ "2025-01-12": 5 } }
             = { "2025-01-12": 5 }
     ‚Üì
‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!
     ‚Üì
useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: leadsCount = 1
     ‚Üì
üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Supabase
     ‚Üì
‚úÖ Supabase –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:

1. **üõ°Ô∏è –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**
   - –î–∞–∂–µ –µ—Å–ª–∏ –≤ Supabase –ø—É—Å—Ç–æ—Ç–∞, –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç –±–∞–∑—É

2. **üöÄ –ü—Ä–æ—Å—Ç–æ—Ç–∞**
   - –ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ —Ç–∏–ø–∞ `lastChangeSource`
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

3. **üí™ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –í–°–ï–ì–î–ê –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
   - Non-Destructive Merge –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å

4. **üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–º**
   - –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
   - –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥–∏

5. **üêõ –õ–µ–≥–∫–∞—è –æ—Ç–ª–∞–¥–∫–∞**
   - –ü—Ä–æ—Å—Ç—ã–µ –ª–æ–≥–∏: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ª–∏–¥–æ–≤: X"
   - –ü–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ

---

## üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã:

### –¢–µ—Å—Ç 1: –û–±—ã—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
1. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–∞ –±—Ä–∞—É–∑–µ—Ä–∞
2. –í–≤–µ–¥–∏—Ç–µ "5" –≤ –ø–µ—Ä–≤–æ–º
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –ø–µ—Ä–≤–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞:
   ```
   üìù –°—Ç–µ–π—Ç –æ–±–Ω–æ–≤–ª–µ–Ω. –õ–∏–¥–æ–≤: 1
   üöÄ –û–ë–ù–ê–†–£–ñ–ï–ù–û –õ–ò–î–û–í: 1. –û–¢–ü–†–ê–í–õ–Ø–Æ...
   ‚úÖ –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–û
   ```
4. –í–æ –≤—Ç–æ—Ä–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è "5"

### –¢–µ—Å—Ç 2: –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
1. –û—á–∏—Å—Ç–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ Supabase (–∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ)
2. –í–≤–µ–¥–∏—Ç–µ "5" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –°–∏—Å—Ç–µ–º–∞:
   - –ü–æ–ª—É—á–∏—Ç –ø—É—Å—Ç–æ—Ç—É —Å —Å–µ—Ä–≤–µ—Ä–∞
   - –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à—É—Ç –ø—É—Å—Ç–æ—Ç—É (—É–º–Ω—ã–π –º–µ—Ä–∂–∏–Ω–≥)
   - –û—Ç–ø—Ä–∞–≤–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Supabase
4. Supabase –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! ‚úÖ

### –¢–µ—Å—Ç 3: Concurrent edits
1. –í –ø–µ—Ä–≤–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –≤–≤–µ–¥–∏—Ç–µ "5"
2. –í–æ –≤—Ç–æ—Ä–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (–¥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏) –≤–≤–µ–¥–∏—Ç–µ "3"
3. –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
   - –í –ø–µ—Ä–≤–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –±—É–¥–µ—Ç "5"
   - –í–æ –≤—Ç–æ—Ä–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –±—É–¥–µ—Ç "3"
   - –í Supabase –±—É–¥–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
4. –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω—ã! ‚úÖ

---

## üéâ –ò—Ç–æ–≥

–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞:
- ‚úÖ **–ü—Ä–æ—â–µ** - –Ω–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–µ–µ** - –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
- ‚úÖ **–£–º–Ω–µ–µ** - —Å–∞–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ** - –º–µ–Ω—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ —É—Å–ª–æ–≤–∏–π

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:** –î–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–º, –∞ –Ω–µ —Ñ–ª–∞–≥–∞–º! üöÄ
