# ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ä–∂–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö**
**–ë—ã–ª–æ:** –°—Ä–∞–≤–Ω–∏–≤–∞–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–ª–∏, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
```typescript
const localLeadsCount = Object.keys(localProj.leads || {}).length;
const serverLeadsCount = Object.keys(serverProj.leads || {}).length;
const mergedLeads = (serverLeadsCount > 0 || localLeadsCount === 0) 
  ? { ...serverProj.leads } 
  : { ...localProj.leads };
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—à–ª–∏ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ `{}`, –æ–Ω–∏ —Å—Ç–∏—Ä–∞–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!

**–°—Ç–∞–ª–æ:** Non-Destructive Merge (–Ω–µ—Ä–∞–∑—Ä—É—à–∞—é—â–µ–µ —Å–ª–∏—è–Ω–∏–µ)
```typescript
const mergedLeads = { ...serverProj.leads, ...localProj.leads };
const mergedWeeks = { ...serverProj.weeks, ...localProj.weeks };
```
**–†–µ—à–µ–Ω–∏–µ:** –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö.

---

### 2. **–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**
**–ë—ã–ª–æ:** `useEffect` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø—Ä–∏ **–ª—é–±–æ–º** –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `data`, –¥–∞–∂–µ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –æ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞.

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –í–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
- –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç Supabase ‚Üí —Å–Ω–æ–≤–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
- –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç Supabase ‚Üí —Å–Ω–æ–≤–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º...
- **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª!**

**–°—Ç–∞–ª–æ:** –î–æ–±–∞–≤–∏–ª–∏ `lastChangeSource` ref –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```typescript
const lastChangeSource = React.useRef<'local' | 'server'>('server');

// –í handleUpdate
lastChangeSource.current = 'local'; // –ü–æ–º–µ—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

// –í –ø–æ–¥–ø–∏—Å–∫–µ
lastChangeSource.current = 'server'; // –ü–æ–º–µ—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

// –í useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
if (lastChangeSource.current !== 'local') {
  console.log('‚è∏Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
  return;
}
```
**–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

---

### 3. **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏**
**–ë—ã–ª–æ:** –í `updateUserProjects` –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `leads` –∏ `weeks`
```typescript
projects: updatedProjects.map(p => ({
  ...p,
  leads: { ...p.leads },  // –ú–æ–∂–µ—Ç –±—ã—Ç—å undefined
  weeks: { ...p.weeks }   // –ú–æ–∂–µ—Ç –±—ã—Ç—å undefined
}))
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `p.leads` –±—ã–ª `undefined`, —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç `{}`.

**–°—Ç–∞–ª–æ:** –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å fallback
```typescript
projects: updatedProjects.map(p => ({
  ...p,
  leads: { ...(p.leads || {}) },  // –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –Ω–µ undefined
  weeks: { ...(p.weeks || {}) }
}))
```
**–†–µ—à–µ–Ω–∏–µ:** –î–∞–∂–µ –µ—Å–ª–∏ `leads` –∏–ª–∏ `weeks` –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –∞ –Ω–µ `undefined`.

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ:

### 1. –î–æ–±–∞–≤–ª–µ–Ω `lastChangeSource` ref
```typescript
const lastChangeSource = React.useRef<'local' | 'server'>('server');
```
–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `handleUpdate`
```typescript
const handleUpdate = (updater: (prev: AppData) => AppData) => {
  lastChangeSource.current = 'local'; // –ü–æ–º–µ—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  setData(prev => updater(prev));
};
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –º–µ—Ä–∂–∏–Ω–≥–∞ –≤ –ø–æ–¥–ø–∏—Å–∫–µ
```typescript
const mergedLeads = { ...serverProj.leads, ...localProj.leads };
const mergedWeeks = { ...serverProj.weeks, ...localProj.weeks };
```
Non-Destructive Merge: –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è.

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `useEffect` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```typescript
if (lastChangeSource.current !== 'local') {
  console.log('‚è∏Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
  return;
}
```
–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `updateUserProjects`
```typescript
leads: { ...(p.leads || {}) },
weeks: { ...(p.weeks || {}) }
```
–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

## üöÄ –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç "5" –≤ –ø–æ–ª–µ
         ‚Üì
onChange ‚Üí handleLeadChange ‚Üí handleUpdate
         ‚Üì
lastChangeSource.current = 'local' ‚úÖ
         ‚Üì
setData ‚Üí State –æ–±–Ω–æ–≤–ª–µ–Ω
         ‚Üì
useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (source === 'local')
         ‚Üì
üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Supabase
         ‚Üì
isSyncingRef.current = true (–±–ª–æ–∫–∏—Ä—É–µ–º —ç—Ö–æ)
         ‚Üì
lastChangeSource.current = 'server' (—Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –¥–∞–Ω–Ω—ã–µ
         ‚Üì
üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ –∏–∑ Supabase
         ‚Üì
subscribeToDataChanges callback
         ‚Üì
isSyncingRef.current? –ù–µ—Ç ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
         ‚Üì
lastChangeSource.current = 'server' ‚úÖ
         ‚Üì
setData ‚Üí State –æ–±–Ω–æ–≤–ª–µ–Ω (Non-Destructive Merge)
         ‚Üì
useEffect —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ù–ï —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (source === 'server') ‚è∏Ô∏è
         ‚Üì
–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤!
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:

1. **–î–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è** - Non-Destructive Merge –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç, –∞ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç
2. **–ù–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞** - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **Realtime —Ä–∞–±–æ—Ç–∞–µ—Ç** - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏
4. **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

---

## üß™ –¢–µ—Å—Ç:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–≤—É—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
2. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ –æ–¥–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ò–≤–∞–Ω")
3. –í –ø–µ—Ä–≤–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –≤–≤–µ–¥–∏—Ç–µ "5" –≤ –ø–æ–ª–µ "–•–∏–º–∫–∏ –ü–ù"
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –ø–µ—Ä–≤–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞:**
   ```
   üîÑ handleUpdate –í–´–ó–í–ê–ù! (–∏—Å—Ç–æ—á–Ω–∏–∫: LOCAL)
   ‚úÖ Guard –ø—Ä–æ–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞—é —Ç–∞–π–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è...
   üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–∞–∑—É...
   ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–ª–µ—Ç–µ–ª–∏ –≤ Supabase
   ```
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –≤—Ç–æ—Ä–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞:**
   ```
   üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ –∏–∑ Supabase
   üì• –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã: { totalLeads: 5, totalLeadEntries: 1 }
   ‚è∏Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
   ```
6. **–í–æ –≤—Ç–æ—Ä–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Ü–∏—Ñ—Ä–∞ "5"!**

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è, –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
